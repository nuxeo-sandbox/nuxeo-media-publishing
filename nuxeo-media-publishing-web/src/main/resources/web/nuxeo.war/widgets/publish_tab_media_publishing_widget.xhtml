<div xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:c="http://java.sun.com/jstl/core"
     xmlns:nxl="http://nuxeo.org/nxforms/layout"
     xmlns:a4j="http://richfaces.org/a4j"
     xmlns:nxu="http://nuxeo.org/nxweb/util">

  <h:form>
    <a4j:region>
      <a4j:poll id="poll" interval="10000" enabled="true" render="poll,providers"/>
    </a4j:region>

    <a4j:jsFunction name="clearAccount" render="providers">
      <a4j:param name="account" value="" assignTo="#{mediaPublishing.selectedAccount}"/>
    </a4j:jsFunction>
  </h:form>

  <h:panelGroup id="providers">
    <c:set var="doc" value="#{mediaPublishing.currentDoc}" scope="request"/>
    <c:forEach var="provider" items="#{mediaPublishing.getAvailableServices(doc)}">
      <c:set var="uploadStatus" value="#{mediaPublishing.getUploadStatus(doc, provider)}"/>

      <div style="margin-bottom: 10px">
        <h:outputText value="#{provider}" styleClass="labelColumn" style="display: inline-block; width: 125px"/>

        <c:if test="#{not empty uploadStatus}">
          <h:outputText value="#{mediaPublishing.getStatusMessageFor(uploadStatus)}"/>
        </c:if>

        <c:if test="#{empty uploadStatus}">
          <c:set var="providerAccounts" value="#{oauthUserTokens.getProviderAccounts(provider, true)}"/>

          <c:if test="#{not empty providerAccounts}">
            <a href="##{provider}_media_publish_popup" class="button smallButton media_publishing_openPopup">
              <h:outputText value="#{messages['action.mediaPublishing.republish']}" rendered="#{mediaPublishing.isPublished(doc, provider)}"/>
              <h:outputText value="#{messages['action.mediaPublishing.publish']}" rendered="#{not mediaPublishing.isPublished(doc, provider)}"/>
            </a>

            <div style="display:none">
              <div id="#{provider}_media_publish_popup">
                <h:form enctype="multipart/form-data" ajaxSubmit="true">
                  <h3>
                    <h:outputText value="Upload to #{provider}"/>
                  </h3>

                  <h:outputLabel style="margin: 5px 0; display: block">
                    #{provider} account:
                  </h:outputLabel>

                  <h:selectOneMenu value="#{mediaPublishing.selectedAccount}" required="true"
                                   requiredMessage="Please select an account">
                    <f:selectItem itemLabel="Select a value..." itemValue="#{null}"/>
                    <f:selectItems var="entry"
                                   value="#{providerAccounts}"
                                   itemLabel="#{entry.oauth2Token.nuxeoLogin} - #{entry.oauth2Token.serviceLogin}"
                                   itemValue="#{entry.oauth2Token.serviceLogin}"/>
                    <a4j:ajax event="change" execute="@this" render="#{provider}_optionsPanel"/>
                  </h:selectOneMenu>

                  <nxu:set var="providerOptionsWidgets"
                           value="#{mediaPublishing.getProviderOptionsWidgets(provider)}"
                           cache="true">

                    <h:panelGroup id="#{provider}_optionsPanel">
                      <c:forEach var="optionWidget" items="#{providerOptionsWidgets}">
                        <nxl:widget mode="any" name="#{optionWidget.properties.widgetName}"
                                    value="#{mediaPublishing.options}"/>
                      </c:forEach>
                    </h:panelGroup>
                  </nxu:set>

                  <h:commandButton value="#{messages['action.mediaPublishing.publish']}"
                                   action="#{mediaPublishing.publish(provider)}"
                                   class="button smallButton"
                                   style="display: block">
                    <a4j:ajax execute="@form" render="@form" oncomplete="jQuery.fancybox.close();"/>
                  </h:commandButton>
                </h:form>
              </div>
            </div>
          </c:if>

          <c:if test="#{empty providerAccounts}">
            <p style="display: inline-block;">
              #{messages['error.mediaPublishing.emptyAccounts']}
            </p>
          </c:if>
        </c:if>
      </div>
    </c:forEach>

    <script type="text/javascript">
      jQuery(document).ready(function () {

        function clearSelectedAccount() {
          clearAccount();
        }

        var config = {
          'autoScale': true,
          'autoDimensions': true,
          'transitionIn': 'none',
          'transitionOut': 'none',
          'type': 'inline',
          'enableEscapeButton': true,
          'centerOnScroll': true,
          'onClosed': clearSelectedAccount
        };
        jQuery(".media_publishing_openPopup").fancybox(config);
      });
    </script>

  </h:panelGroup>
</div>
