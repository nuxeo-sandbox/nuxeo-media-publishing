<div xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:c="http://java.sun.com/jstl/core"
     xmlns:nxu="http://nuxeo.org/nxweb/util"
     xmlns:a4j="http://richfaces.org/a4j">

    <h:form>
        <a4j:region>
            <a4j:poll id="poll" interval="10000" enabled="true" render="poll,providers" />
        </a4j:region>
    </h:form>

    <h:form id="document_view" enctype="multipart/form-data" ajaxSubmit="true">
        <h:panelGroup id="providers">
            <nxu:repeat var="uploadService" items="#{socialPublishing.getAvailableServices(value)}" varStatus="status">
                <nxu:set var="uploadStatus"
                         value="#{socialPublishing.getUploadStatus(value, uploadService)}">
                    <div style="margin-bottom: 10px">
                        <h:outputText value="#{uploadService}" styleClass="labelColumn" style="display: inline-block; width: 125px"/>

                        <c:if test="#{not empty uploadStatus}">
                                <h:outputText value="#{socialPublishing.getStatusMessageFor(uploadStatus)}"/>
                        </c:if>
                        <c:if test="#{empty uploadStatus}">
                            <c:set var="providerAccounts" value="#{oauthUserTokens.getProviderAccounts(uploadService)}"/>

                            <c:if test="#{not empty providerAccounts}">
                                <a href="##{uploadService}_social_publish_popup" class="button smallButton social_openPopup">
                                    <h:outputText value="#{messages['action.socialMedia.republish']}" rendered="#{socialPublishing.isPublished(value, uploadService)}"/>
                                    <h:outputText value="#{messages['action.socialMedia.publish']}" rendered="#{not socialPublishing.isPublished(value, uploadService)}"/>
                                </a>
                                <div style="display:none">
                                    <div id="#{uploadService}_social_publish_popup">
                                        <h3>
                                            <h:outputText value="Select a #{uploadService} account"/>
                                        </h3>
                                        <h:selectOneMenu style="margin: 10px 0" onchange="updateAccount(this.value)">
                                            <f:selectItem itemLabel="" itemValue="#{null}" noSelectionOption="true" />
                                            <f:selectItems var="entry" value="#{providerAccounts}" itemLabel="#{entry.oauth2Token.nuxeoLogin}" itemValue="#{entry.oauth2Token.nuxeoLogin}" />
                                        </h:selectOneMenu>
                                        <h:form>
                                            <h:commandButton value="#{messages['action.socialMedia.republish']}"
                                                             action="#{socialPublishing.publish(uploadService)}"
                                                             class="button smallButton"
                                                             style="display: block"
                                                             rendered="#{isMediaPublished}">
                                                <a4j:ajax execute="@this" render="@form providers" oncomplete="jQuery.fancybox.close();" />
                                            </h:commandButton>

                                            <h:commandButton value="#{messages['action.socialMedia.publish']}"
                                                             action="#{socialPublishing.publish(uploadService)}"
                                                             class="button smallButton"
                                                             style="display: block"
                                                             rendered="#{not isMediaPublished}">
                                                <a4j:ajax execute="@this" render="@form providers" oncomplete="jQuery.fancybox.close();" />
                                            </h:commandButton>
                                        </h:form>
                                    </div>
                                </div>
                            </c:if>

                            <c:if test="#{empty providerAccounts}">
                                <p style="display: inline-block;">
                                    #{messages['error.socialMedia.emptyAccounts']}
                                </p>
                            </c:if>
                     </c:if>
                    </div>
                </nxu:set>
            </nxu:repeat>

            <script type="text/javascript">
                jQuery(document).ready(function() {
                    var config = {
                        'autoScale'          : true,
                        'autoDimensions'     : true,
                        'transitionIn'       : 'none',
                        'transitionOut'      : 'none',
                        'type'               : 'inline',
                        'enableEscapeButton' : true,
                        'centerOnScroll'     : true
                    };
                    jQuery(".social_openPopup").fancybox(config);
                });
            </script>

        </h:panelGroup>
    </h:form>

    <h:form>
        <a4j:jsFunction name="updateAccount">
            <a4j:param name="account" assignTo="#{socialPublishing.selectedAccount}"  />
        </a4j:jsFunction>
    </h:form>
</div>
